Name: RDP + Tailscale + Google Drive

on:
  workflow_dispatch:
    inputs:
      ts_authkey:
        description: "Tailscale Auth Key"
        required: true
      runtime_minutes:
        description: "Runtime"
        default: "355"

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 370

    env:
      RDP_USER: admin
      RDP_PASS: Admin@123

    steps:

    # -------------------------
    # Install rclone
    # -------------------------
    - name: Install rclone
      run: choco install rclone -y

    # -------------------------
    # Install Tailscale
    # -------------------------
    - name: Install Tailscale
      run: |
        winget install --id Tailscale.Tailscale --accept-package-agreements --accept-source-agreements

    # -------------------------
    # Connect Tailscale
    # -------------------------
    - name: Connect Tailscale
      run: |
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey "${{ inputs.ts_authkey }}" --accept-dns=true
        $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
        echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
        echo "Tailscale IP: $ip"

    # -------------------------
    # Enable RDP
    # -------------------------
    - name: Enable RDP
      run: |
        net user $env:RDP_USER $env:RDP_PASS /add
        net localgroup administrators $env:RDP_USER /add
        reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        netsh advfirewall set allprofiles state off

    # -------------------------
    # Setup Google Drive (FIXED)
    # -------------------------
    - name: Setup Google Drive
      env:
        # Pass the secret as an environment variable here
        RCLONE_CONF_CONTENT: ${{ secrets.GDRIVE_CONFIG }}
      run: |
        $configPath = "$env:APPDATA\rclone"
        # Ensure directory exists (idempotent check)
        if (!(Test-Path $configPath)) { New-Item -ItemType Directory -Path $configPath -Force }
        # Write the env variable to file (Safely handles multiline strings)
        Set-Content -Path "$configPath\rclone.conf" -Value $env:RCLONE_CONF_CONTENT -Encoding UTF8

    # -------------------------
    # Mount Google Drive
    # -------------------------
    - name: Mount Google Drive
      run: |
        mkdir C:\gdrive
        Start-Process rclone -ArgumentList "mount gdrive: C:\gdrive --vfs-cache-mode full --buffer-size 256M" -NoNewWindow

    # -------------------------
    # Install RustDesk
    # -------------------------
    - name: Install RustDesk
      run: |
        $msi="$env:TEMP\rustdesk.msi"
        Invoke-WebRequest https://github.com/rustdesk/rustdesk/releases/download/1.3.1/rustdesk-1.3.1-x86_64.msi -OutFile $msi
        Start-Process msiexec.exe -ArgumentList "/i","`"$msi`"","/quiet" -Wait

    # -------------------------
    # Keep Alive
    # -------------------------
    - name: Keep Alive
      run: |
        $end=(Get-Date).AddMinutes([int]"${{ inputs.runtime_minutes }}")
        while((Get-Date) -lt $end){
          Write-Host "Alive | IP: $env:TAILSCALE_IP"
          Start-Sleep 60
        }
        
